- name: SSH to server and deploy
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: ${{ secrets.HOST_IP }}
    username: ubuntu
    key: ${{ secrets.SSH_PRIVATE_KEY }}
    port: 22
    script_stop: true
    script: |
      echo "--- 开始部署流程 ---"

      # 停止并删除旧容器
      docker stop my-app || true
      docker rm my-app || true

      # 定义重试函数
      retry() {
        local n=1
        local max=3
        local delay=5
        while true; do
          "$@" && break || {
            if [[ $n -lt $max ]]; then
              echo "命令失败，第 $n 次重试...等待 $delay 秒"
              n=$((n+1))
              sleep $delay
            else
              echo "命令最终失败：$*"
              return 1
            fi
          }
        done
      }

      # Docker 登录（私有仓库）
      echo "登录 Docker 仓库..."
      retry docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

      # 拉取最新镜像
      echo "正在拉取最新镜像..."
      retry docker pull ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest

      # 启动新容器
      echo "启动新容器..."
      retry docker run -d \
        --name my-app \
        --restart always \
        -p 8080:8080 \
        ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest

      echo "--- 部署完成 ---"
